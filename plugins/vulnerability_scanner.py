import logging
import requests

class VulnerabilityScanner:
    def __init__(self, api_key):
        self.api_key = api_key
        self.base_url = 'https://services.nvd.nist.gov/rest/json/cves/2.0'

    def search_vulnerabilities(self, cpe_list, product=None, version=None):
        """Pesquisa vulnerabilidades usando uma lista de CPEs ou produto e versão."""
        vulnerabilities = []
        headers = {'apiKey': self.api_key}
        params = {
            'resultsPerPage': 2000
        }

        for cpe in cpe_list:
            logging.debug(f"Buscando vulnerabilidades para o CPE: {cpe}")
            params['cpeName'] = cpe  # Use 'cpeName' ou 'cpeMatchString'
            try:
                response = requests.get(self.base_url, headers=headers, params=params)
                response.raise_for_status()
                data = response.json()

                # Log da URL da requisição
                logging.debug(f"URL da requisição: {response.url}")

                # Processar os dados para extrair vulnerabilidades
                vulnerabilities.extend(self.process_vulnerabilities(data))
            except requests.HTTPError as http_err:
                logging.error(f"Erro HTTP ao buscar vulnerabilidades para {cpe}: {http_err}")
            except Exception as e:
                logging.error(f"Erro inesperado ao buscar vulnerabilidades para {cpe}: {e}")

        # Se não encontrar vulnerabilidades pelo CPE e tiver produto e versão, tentar busca alternativa
        if not vulnerabilities and product:
            logging.warning(f"CPE não encontrado: {cpe_list}. Tentando busca alternativa.")
            logging.info(f"Tentando busca alternativa para produto: {product} versão {version}")
            params = {
                'keywordSearch': f"{product} {version}",
                'resultsPerPage': 2000
            }
            try:
                response = requests.get(self.base_url, headers=headers, params=params)
                response.raise_for_status()
                data = response.json()

                # Log da URL da requisição
                logging.debug(f"URL da requisição: {response.url}")

                # Processar os dados para extrair vulnerabilidades
                vulnerabilities.extend(self.process_vulnerabilities(data))
            except requests.HTTPError as http_err:
                logging.error(f"Erro HTTP ao buscar vulnerabilidades para o produto {product}: {http_err}")
            except Exception as e:
                logging.error(f"Erro inesperado ao buscar vulnerabilidades para o produto {product}: {e}")

        return vulnerabilities

    def process_vulnerabilities(self, data):
        """Processa os dados retornados pela API da NVD."""
        vulnerabilities = []
        for item in data.get('vulnerabilities', []):
            cve = item.get('cve', {})
            vuln_info = {
                'id': cve.get('id', ''),
                'description': cve.get('descriptions', [{}])[0].get('value', ''),
                'cvss3_score': cve.get('metrics', {}).get('cvssMetricV31', [{}])[0].get('cvssData', {}).get('baseScore', ''),
                'cvss2_score': cve.get('metrics', {}).get('cvssMetricV2', [{}])[0].get('cvssData', {}).get('baseScore', ''),
                'url': f"https://nvd.nist.gov/vuln/detail/{cve.get('id', '')}"
            }
            vulnerabilities.append(vuln_info)
        return vulnerabilities
